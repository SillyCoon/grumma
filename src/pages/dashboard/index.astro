---
import Layout from "@layouts/Layout.astro";

import DashboardCell from "@components/DashboardCell.astro";
import { Card, CardContent, CardHeader, CardTitle } from "@components/ui/card";
import { BarList } from "@components/ui/progress-bar-list";
import { actions } from "astro:actions";
import { Range, Map as IMap, Seq, List } from "immutable";
import { diffDays } from "@formkit/tempo";

const { data: dashboard } = await Astro.callAction(actions.dashboard, {});

// const schedule: Schedule = await (await fetchSchedule(Astro)).json();
const { user } = Astro.locals;

const torfl =
  dashboard?.inReviewByTorflCount.map((v) => ({
    id: v.torfl,
    name: v.torfl,
    total: v.total,
    value: v.count,
  })) ?? [];

function getNextWeekAbbreviations(): string[] {
  // Create an array of the full names of the days of the week
  const daysOfWeek = [
    "Sunday",
    "Monday",
    "Tuesday",
    "Wednesday",
    "Thursday",
    "Friday",
    "Saturday",
  ];

  const todayIndex = new Date().getDay();

  return [
    "Today",
    ...Range(1, 7)
      .map((v) => {
        const currentDayIndex = (todayIndex + v) % 7; // Loop around the week
        return daysOfWeek[currentDayIndex].substring(0, 3);
      })
      .toArray(),
  ];
}

const schedule = dashboard?.schedule ?? [];

const countByDaysOfTheWeek: number[] = [];

const today = new Date();

Seq(schedule)
  .sortBy((v) => v.availableAt)
  .forEach((v) => {
    const diffWithToday = diffDays(v.availableAt, today);
    const adjustedDiff = diffWithToday > 0 ? diffWithToday : 0;
    if (diffWithToday > 6) return;
    for (let i = adjustedDiff; i <= 6; i++) {
      countByDaysOfTheWeek[i] = (countByDaysOfTheWeek[i] ?? 0) + 1;
    }
  });

const weekSchedule = Seq(getNextWeekAbbreviations()).zip(
  List(countByDaysOfTheWeek),
);

const dataDay = weekSchedule
  .map(([v, i]) => ({
    value: i,
    name: v,
    id: v,
    total: 10,
  }))
  .toArray();
---

<Layout title="Dashboard" transition:persist>
  <section
    class="grid grid-flow-row-dense grid-cols-1 lg:grid-cols-3 md:grid-cols-2 md:gap-y-10 gap-5"
  >
    <DashboardCell
      title="Learn"
      description="Get the new lesson"
      color="bg-primary"
      count={1}
      href="/sr/lesson"
    />
    <DashboardCell
      title="Reviews"
      description="Review the lessons you've learned"
      color="bg-secondary"
      count={dashboard?.reviewsCount ?? 0}
      href="/sr/review"
    />

    <Card class="col-span-1">
      <CardHeader>
        <CardTitle>Streak</CardTitle>
      </CardHeader>
      <CardContent>
        <p>Keep it up, {user?.email}</p>
        <p>
          You have studied for <span class="text-secondary"
            >{dashboard?.streak}</span
          > days in a row!
        </p>
      </CardContent>
    </Card>

    <Card class="col-span-1 xl:col-span-2">
      <CardHeader>
        <CardTitle>TORFL test level grammar coverage</CardTitle>
      </CardHeader>
      <CardContent>
        <p
          class="mt-4 flex items-center justify-between text-foregrounds-secondary"
        >
          <span>Level</span>
          <span>Studied</span>
        </p>
        <BarList data={torfl} class="mt-2" />
      </CardContent>
    </Card>

    <Card class="col-span-1 row-span-2">
      <CardHeader>
        <CardTitle>Review forecast</CardTitle>
      </CardHeader>
      <CardContent>
        <p>
          Soon in your review queue will appear grammar points ready for review:
        </p>
        <!-- TODO: I'm not 100% sure that timezone is correctly recalculated, so it's better to leave it client:only in the end -->
        <BarList client:load data={dataDay} class="mt-2" />
      </CardContent>
    </Card>
  </section>
</Layout>
